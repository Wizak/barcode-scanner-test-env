<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>BLE Barcode Scanner</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #status { margin-top: 1em; color: green; }
    #error { color: red; }
    ul { margin-top: 10px; }
    li { margin: 4px 0; }
  </style>
</head>
<body>

<h1>üîó BLE –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥—ñ–≤</h1>
<button id="connectBtn">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä</button>
<div id="status">–°—Ç–∞–Ω: –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ</div>
<div id="error"></div>

<h2>üì¶ –û—Ç—Ä–∏–º–∞–Ω—ñ –∫–æ–¥–∏:</h2>
<ul id="scans"></ul>

<script>
  const SERVICE_UUID = '0000ae30-0000-1000-8000-00805f9b34fb';
  const SERVICE_CHAR_UUID = '0000ae02-0000-1000-8000-00805f9b34fb';
  const SCANNER_NAME = 'BARCODE SCANNER';

  let notifyChar = null;

  document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
      clearError();
      updateStatus("–ó–∞–ø–∏—Ç –ø—Ä–∏—Å—Ç—Ä–æ—é...");

      const device = await navigator.bluetooth.requestDevice({
        filters: [{ name: SCANNER_NAME }],
        optionalServices: [SERVICE_UUID]
      });

      updateStatus("–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ " + device.name + "...");

      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      const characteristics = await service.getCharacteristics();

      notifyChar = characteristics.find(c => c.properties.notify && c.uuid === SERVICE_CHAR_UUID);
      if (!notifyChar) throw new Error("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ notify-—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É");

      await notifyChar.startNotifications();
      notifyChar.addEventListener('characteristicvaluechanged', handleNotification);

      updateStatus("–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ. –û—á—ñ–∫—É—î–º–æ —Å–∫–∞–Ω...");
    } catch (err) {
      showError("‚ùå " + err.message);
      console.error(err);
    }
  });

  function handleNotification(event) {
    const value = event.target.value;
    const decoded = new TextDecoder().decode(value.buffer);
    addScan(decoded);
  }

  function addScan(text) {
    const li = document.createElement('li');
    li.textContent = text;
    document.getElementById('scans').appendChild(li);
  }

  function updateStatus(msg) {
    document.getElementById('status').textContent = "–°—Ç–∞–Ω: " + msg;
  }

  function showError(msg) {
    document.getElementById('error').textContent = msg;
  }

  function clearError() {
    document.getElementById('error').textContent = '';
  }
</script>

</body>
</html>
